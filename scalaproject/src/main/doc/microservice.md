# 微服务

## 单体应用的问题
>* 部署效率底下。单体应用代码增加，依赖的资源就会增加，部署的时间就会增加。
>* 团队协作开发成本高。协同开发，会出现代码冲突、重复测试，效率低。
>* 系统高可用性差。如果依赖的资源有问题，就会导致整个应用有问题。
>* 线上发布变慢。规模变大，线上发布的实现就会增加。


## 微服务的特点
>* 服务拆分力度更细。将一个大模块拆分为多个小模块，独立成为一个服务。
>* 服务独立部署。每个服务遵循独立打包部署的准则。
>* 服务独立维护。每个服务可以交给几个人开发、测试、发布和运维等。
>* 服务治理能力要求高。服务数量增加，需要有服务治理平台，进行统一管理。

## 服务拆分方式
>* 纵向拆分:从业务唯独拆分。关联紧密的业务拆分为一个微服务，功能相对独立的，拆分为一个微服务。
>* 横向拆分:从公共且独立功能纬度拆分。将功能组件拆分出来。

## 服务化拆分的前置条件
>* 服务如何定义:每个服务都运行在各自的进程之中，通过接口来进行通信。
>* 服务如何发布和订阅:拆分为微服务之后，如何知道那个服务是提供者、消费者。
>* 服务如何监控:要保证SLA，必须要对服务进行监控，能够及时发现问题，需要知道哪些是重要指标。
>* 服务如何治理:服务之间依赖关系变服务，如何保证当前服务出现问题，其他的服务不受影响。
>* 故障如何定位:系统出现问题，如何快速定位到问题的出处。

## 服务组件
### 服务描述
服务调用首先要解决的问题就是服务如何对外描述。常用的服务描述方式包括RESTful API、XML配置和IDL文件三种。

RESTful API使用http协议的服务描述。

XML配置方式多用RPC协议的服务描述，通过*.xml配置文件来定义接口名、参数以及返回值类型等。

IDL文件方式通常用作Thrift和gRPC这类跨语言服务框架中(thrift使用的是tcp，四层，grpc使用的是七层)。

RESTful API、XML、IDL的区别:

|服务描述方式|使用场景|缺点|
|----|----|----|
|RESTful|跨语言平台，组织内外皆可|使用了HTTP作为通信协议，相比TCP协议，性能较差|
|XML配置|Java平台，一般用作组织内部|不支持跨语言平台|
|IDL文件|跨语言平台，组织内外平台皆可|修改或者删除PB字段不能向前兼容|
如果企业内部之间的服务调用，并且都是Java语言的话，选择xml配置方式是最简单的。
如果企业内部存在多个服务，并且服务采用的是不通过语言平台，建议使用IDL文件方式进行描述服务。
如果还存在对外开放服务调用的情形的话，使用RESTful API方式更加通用。
例如：A项目使用Consul，对应RESTful；B项目使用dubbo，对应XML；C项目设计Java和Python服务之间调用，使用thrift，对应IDL文件。


### 注册中心

注册中心的工作流程是:
>* 服务提供者在启动时，根据服务发布文件中配置的发布信息向注册中心注册自己的服务。
>* 服务消费者在启动时，根据消费者配置文件中配置的服务信息向注册中心订阅自己所需要的服务。
>* 注册中心返回服务提供者地址列表给服务消费者。
>* 当服务提供者发生变化，注册中心将变更通知给服务消费者。

### 服务框架

>* 服务通信协议:四层TCP、UDP，还是7层HTTP协议
>* 数据传输方式:同步/异步。
>* 数据压缩格式:数据传输会对数据进行压缩，减少网络传输的数据量，例如JSON序列化、Java序列化和Protobuf序列化。

### 服务监控
服务监控主要包括三个流程:
>* 指标收集:每次调用请求耗时以及成功与否收集起来，并传到集中的数据处理中心。
>* 数据处理:计算QPS、请求平均耗时以及成功率等指标。
>* 数据展示:将收到的指标进行处理之后，在页面上展示。

### 服务追踪
服务追踪工作原理:
>* 服务消费者发起请求前，按照规则生成一个requestid，发起调用时，将requestid当作请求参数的一部分，传递给服务提供者。
>* 服务提供者接收到请求后，记录这次请求的requestid，然后处理请求。如果需要调用其他服务，按照之前的流程走一遍。

### 服务治理
>* 单机故障:系统规模大，出现故障机器比较多，人力需求量大，需要做到自动移除故障节点,保证服务正常。
>* IDC故障:IDC之间可以切换流量。
>* 依赖服务不可用。通过熔断方式，保证其他服务的正常使用。
